<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Econventure | Economics for High Schoolers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .hidden { display: none; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; display: flex; align-items: center; justify-content: center; }
        .nav-link.active { color: white; font-weight: 700; }
        .article-content h1, .article-content h2, .article-content h3 { font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; }
        .article-content h1 { font-size: 2.25rem; } .article-content h2 { font-size: 1.875rem; } .article-content h3 { font-size: 1.5rem; }
        .article-content p { margin-bottom: 1em; line-height: 1.6; } .article-content a { color: #f59e0b; text-decoration: underline; }
        .article-content ul, .article-content ol { margin-left: 1.5rem; margin-bottom: 1em; } .article-content li { margin-bottom: 0.5em; }
        .article-content blockquote { border-left: 4px solid #e2e8f0; padding-left: 1rem; margin-left: 0; font-style: italic; color: #64748b; }
        #chat-messages { height: 60vh; }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header Section -->
    <header class="bg-slate-800 shadow-lg sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="text-2xl font-extrabold text-white tracking-tight"><a href="#" class="nav-link" data-target="home-section">Econventure</a></div>
            <div class="hidden md:flex items-center space-x-6">
                <a href="#" class="nav-link text-slate-300 hover:text-white" data-target="home-section">Home</a>
                <a href="#" class="nav-link text-slate-300 hover:text-white" data-target="topics-section">Topics</a>
                <a href="#" class="nav-link text-slate-300 hover:text-white" data-target="forum-section">Forum</a>
                <a href="#" class="nav-link text-slate-300 hover:text-white" data-target="chat-section">Chat</a>
                <a href="#" class="nav-link text-slate-300 hover:text-white" data-target="members-section">Members</a>
                <a href="#" id="nav-submit-link" class="nav-link text-slate-300 hover:text-white hidden" data-target="submit-section">Submit</a>
                
                <div id="auth-links" class="space-x-2"><button id="login-btn" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">Login</button><button id="signup-btn" class="bg-amber-500 text-slate-900 font-semibold py-2 px-4 rounded-lg hover:bg-amber-400">Sign Up</button></div>
                <div id="user-links" class="hidden items-center space-x-4"><a href="#" id="nav-profile-link" class="nav-link text-slate-300 hover:text-white" data-target="profile-section">Profile</a><button id="logout-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700">Log Out</button></div>
            </div>
            <div class="md:hidden"><button id="mobile-menu-button" class="text-white focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-slate-800 px-6 pb-4"></div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto px-6 py-12">
        
        <section id="home-section" class="page-section"><h1 class="text-4xl font-bold mb-8 text-slate-900">Latest Articles</h1><div id="latest-articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div></section>
        
        <section id="article-view-section" class="page-section hidden"><div class="max-w-4xl mx-auto"><button class="back-btn mb-8 text-slate-600 font-semibold hover:text-slate-800">&larr; Back</button><div class="bg-white p-8 md:p-12 rounded-xl shadow-lg"><p id="article-view-category" class="text-sm font-semibold text-amber-600 uppercase tracking-wider"></p><h1 id="article-view-title" class="text-4xl md:text-5xl font-extrabold text-slate-900 mt-2 mb-6"></h1><div id="article-view-author" class="flex items-center mb-8"></div><div id="article-view-content" class="article-content text-lg text-slate-700"></div><hr class="my-8"><div class="flex items-center space-x-4"><button id="like-article-btn" class="flex items-center space-x-2 text-slate-600 hover:text-red-500 disabled:text-red-500"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg><span>Like</span></button><span id="like-count" class="font-semibold text-slate-700"></span></div><div id="comments-section" class="mt-12"></div></div></div></section>

        <section id="topics-section" class="page-section hidden"><div class="text-center mb-16"><h1 class="text-5xl font-extrabold text-slate-900">Explore Our Topics</h1><p class="text-xl text-slate-600 mt-4 max-w-3xl mx-auto">Browse articles by category.</p></div><div id="topics-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></section>
        
        <section id="category-view-section" class="page-section hidden"><button class="back-btn mb-8 text-slate-600 font-semibold hover:text-slate-800">&larr; Back to Topics</button><h1 id="category-view-title" class="text-4xl font-bold mb-8 text-slate-900"></h1><div id="category-articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div></section>
        
        <section id="forum-section" class="page-section hidden"><div class="flex justify-between items-center mb-8"><h1 class="text-4xl font-bold text-slate-900">Discussion Forum</h1><button id="create-post-btn" class="bg-amber-500 text-slate-900 font-semibold py-2 px-4 rounded-lg hover:bg-amber-400">Create New Post</button></div><div id="forum-posts-list" class="space-y-4"></div></section>
        
        <section id="forum-post-view-section" class="page-section hidden"><div class="max-w-4xl mx-auto"><button class="back-btn mb-8 text-slate-600 font-semibold hover:text-slate-800">&larr; Back to Forum</button><div id="forum-post-content" class="bg-white p-8 rounded-xl shadow-lg"></div><div id="forum-replies-section" class="mt-8"></div></div></section>
        
        <section id="create-forum-post-section" class="page-section hidden"><div class="max-w-2xl mx-auto"><button class="back-btn mb-8 text-slate-600 font-semibold hover:text-slate-800">&larr; Back to Forum</button><h1 class="text-4xl font-bold mb-8 text-slate-900">Create a New Discussion Post</h1><div class="bg-white p-8 rounded-xl shadow-lg"><form id="create-post-form"><div class="space-y-4"><input type="text" id="post-title" placeholder="Post Title" required class="w-full px-4 py-2 border rounded-lg"><textarea id="post-content" rows="6" placeholder="What's on your mind?" required class="w-full px-4 py-2 border rounded-lg"></textarea><button type="submit" class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Post</button></div></form></div></div></section>
        
        <section id="chat-section" class="page-section hidden"><h1 class="text-4xl font-bold mb-8 text-slate-900">Live Chat</h1><div class="bg-white rounded-xl shadow-lg p-4"><div id="chat-messages" class="overflow-y-auto mb-4 border rounded-lg p-4 bg-slate-50"></div><form id="chat-form" class="flex space-x-2"><input type="text" id="chat-input" placeholder="Type a message..." required class="flex-grow px-4 py-2 border rounded-lg"><button type="submit" class="bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-600">Send</button></form></div></section>
        
        <section id="members-section" class="page-section hidden"><div class="text-center mb-16"><h1 class="text-5xl font-extrabold text-slate-900">Our Authors</h1><p class="text-xl text-slate-600 mt-4 max-w-3xl mx-auto">Meet the global community of student writers.</p></div><div id="members-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8"></div></section>
        
        <section id="about-section" class="page-section hidden"><div class="max-w-4xl mx-auto"><div class="text-center mb-12"><h1 class="text-5xl font-extrabold text-slate-900">About Econventure</h1><p class="text-xl text-slate-600 mt-4">Demystifying economics, one article at a time.</p></div><div class="bg-white p-8 rounded-xl shadow-lg mb-12"><h2 class="text-3xl font-bold text-slate-900 mb-4">Our Mission</h2><p class="text-lg text-slate-600 leading-relaxed">Econventure was founded on a simple belief: economics shouldn't be intimidating. It's the story of our choices, our communities, and our world...</p></div></div></section>
        
        <section id="submit-section" class="page-section hidden"><div class="max-w-4xl mx-auto"><div class="text-center mb-12"><h1 class="text-5xl font-extrabold text-slate-900">Submit Your Article</h1></div><div class="bg-white p-8 rounded-xl shadow-lg"><form id="article-submission-form"><div class="space-y-6"><input type="text" id="article-title" placeholder="Article Title" required class="w-full px-3 py-2 border rounded-md"><select id="article-category" required class="w-full px-3 py-2 border rounded-md"><option>-- Please select a category --</option><option>Macroeconomics</option><option>Microeconomics</option><option>Personal Finance</option><option>Investing & Stock Market</option><option>Behavioral Economics</option><option>International Trade</option><option>Game Theory</option><option>Environmental Economics</option><option>Business & Entrepreneurship</option><option>Technology & The Digital Economy</option><option>Career Corner</option><option>Economic History</option><option>Book/Movie Review</option><option>Current Events Analysis</option><option>Other</option></select><textarea id="article-draft" rows="10" required class="w-full px-3 py-2 border rounded-md" placeholder="Write your article here..."></textarea><button type="submit" class="w-full bg-slate-700 text-white font-bold py-3 px-6 rounded-lg">Submit for Review</button></div></form></div></div></section>
        
        <section id="profile-section" class="page-section hidden"><div class="max-w-2xl mx-auto"><div class="text-center mb-12"><h1 class="text-5xl font-extrabold text-slate-900">Your Author Profile</h1></div><div class="bg-white p-8 rounded-xl shadow-lg"><form id="profile-form"><div class="space-y-6"><div class="flex flex-col items-center"><img id="profile-pic-preview" src="https://placehold.co/128x128/e2e8f0/334155?text=Avatar" class="w-32 h-32 rounded-full mb-4 object-cover"><input type="file" id="profile-pic-upload" accept="image/*" class="text-sm"></div><input type="text" id="profile-username" required placeholder="Username" class="w-full px-3 py-2 border rounded-md"><input type="text" id="profile-name" required placeholder="Full Name" class="w-full px-3 py-2 border rounded-md"><textarea id="profile-bio" rows="4" class="w-full px-3 py-2 border rounded-md" placeholder="Author Bio..."></textarea><button type="submit" class="w-full bg-slate-700 text-white font-bold py-3 px-6 rounded-lg">Save Profile</button></div></form></div></div></section>
        
    </main>
    
    <!-- Modals -->
    <div id="login-modal" class="modal modal-backdrop hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative"><button id="close-login-modal" class="absolute top-4 right-4 text-slate-600 text-2xl font-bold">&times;</button><h2 class="text-2xl font-bold text-center mb-6">Login</h2><form id="login-form"><div class="space-y-4"><input type="email" id="login-email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg"><input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-2 border rounded-lg"><button type="submit" class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg">Login</button></div></form></div></div>
    <div id="signup-modal" class="modal modal-backdrop hidden"><div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative"><button id="close-signup-modal" class="absolute top-4 right-4 text-slate-600 text-2xl font-bold">&times;</button><h2 class="text-2xl font-bold text-center mb-6">Create Account</h2><form id="signup-form"><div class="space-y-4"><input type="email" id="signup-email" placeholder="Email" required class="w-full px-4 py-2 border rounded-lg"><input type="password" id="signup-password" placeholder="Password (min. 6 characters)" required class="w-full px-4 py-2 border rounded-lg"><button type="submit" class="w-full bg-amber-500 text-slate-900 font-bold py-3 rounded-lg">Sign Up</button></div></form></div></div>
    <div id="message-box" class="fixed bottom-5 right-5 bg-slate-800 text-white py-3 px-5 rounded-lg shadow-lg hidden z-[110]"></div>

    <!-- Firebase SDKs and App Logic -->
    <script type="module">
        // =================================================================================================
        // ==  IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION OBJECT HERE                                   ==
        // ==  The (auth/invalid-api-key) error means you haven't done this step correctly.             ==
        // ==  Delete the placeholder below and paste your config from the Firebase Console.            ==
        // =================================================================================================
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAdxuptlaWc8qr77lapfCVpQkzNpIz3Hng",
  authDomain: "econventure-3bb7e.firebaseapp.com",
  projectId: "econventure-3bb7e",
  storageBucket: "econventure-3bb7e.firebasestorage.app",
  messagingSenderId: "806695407866",
  appId: "1:806695407866:web:fb9c87e3304286e9793943",
  measurementId: "G-KNYNWLCT37"
};
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, getDocs, query, where, orderBy, limit, serverTimestamp, onSnapshot, updateDoc, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const markdownConverter = new showdown.Converter();
        let currentArticleId = null;
        let chatUnsubscribe = null;

        const ui = {
            pageSections: document.querySelectorAll('.page-section'),
            navLinks: document.querySelectorAll('.nav-link'),
            authLinks: document.getElementById('auth-links'),
            userLinks: document.getElementById('user-links'),
            navSubmitLink: document.getElementById('nav-submit-link'),
            mobileMenu: document.getElementById('mobile-menu'),
            messageBox: document.getElementById('message-box'),
            loginModal: document.getElementById('login-modal'),
            signupModal: document.getElementById('signup-modal'),
            backBtns: document.querySelectorAll('.back-btn'),
        };

        const topics = ['Macroeconomics', 'Microeconomics', 'Personal Finance', 'Investing & Stock Market', 'Behavioral Economics', 'International Trade', 'Game Theory', 'Environmental Economics', 'Business & Entrepreneurship', 'Technology & The Digital Economy', 'Career Corner', 'Economic History', 'Book/Movie Review', 'Current Events Analysis', 'Other'];

        // --- NAVIGATION & UI ---
        function navigateTo(targetId, context = null) {
            ui.pageSections.forEach(section => section.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');
            ui.navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === targetId));

            if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; }

            switch(targetId) {
                case 'home-section': fetchAndDisplayArticles(); break;
                case 'members-section': fetchAndDisplayMembers(); break;
                case 'topics-section': displayTopics(); break;
                case 'category-view-section': showCategory(context); break;
                case 'article-view-section': showArticle(context); break;
                case 'forum-section': fetchForumPosts(); break;
                case 'forum-post-view-section': showForumPost(context); break;
                case 'chat-section': setupChat(); break;
            }
        }

        function showMessage(message, isError = false) {
            ui.messageBox.textContent = message;
            ui.messageBox.classList.remove('hidden');
            ui.messageBox.style.backgroundColor = isError ? '#dc2626' : '#1e293b';
            setTimeout(() => ui.messageBox.classList.add('hidden'), 3000);
        }

        function updateUIForUser(user) {
            ui.authLinks.classList.toggle('hidden', !!user);
            ui.userLinks.classList.toggle('hidden', !user);
            ui.navSubmitLink.classList.toggle('hidden', !user);
            if (user) loadUserProfile(user); else if (!['home-section', 'topics-section', 'members-section', 'about-section'].some(id => !document.getElementById(id).classList.contains('hidden'))) navigateTo('home-section');
            updateMobileMenu(user);
        }
        
        function updateMobileMenu(user) {
            ui.mobileMenu.innerHTML = '';
            const links = [ { text: 'Home', target: 'home-section' }, { text: 'Topics', target: 'topics-section' }, { text: 'Forum', target: 'forum-section' }, { text: 'Chat', target: 'chat-section' }, { text: 'Members', target: 'members-section' }];
            if (user) { links.push({ text: 'Submit Article', target: 'submit-section' }, { text: 'Profile', target: 'profile-section' }); }
            links.forEach(linkInfo => {
                 const a = document.createElement('a');
                 a.href = '#'; a.textContent = linkInfo.text; a.className = 'nav-link block text-slate-300 hover:text-white py-2'; a.dataset.target = linkInfo.target;
                 a.addEventListener('click', e => { e.preventDefault(); navigateTo(linkInfo.target); ui.mobileMenu.classList.add('hidden'); });
                 ui.mobileMenu.appendChild(a);
            });
        }

        // --- AUTH ---
        onAuthStateChanged(auth, updateUIForUser);
        document.getElementById('signup-form').addEventListener('submit', async e => { e.preventDefault(); try { const cred = await createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-password').value); await setDoc(doc(db, "users", cred.user.uid), { email: cred.user.email, name: "", bio: "", username: "", profilePicUrl: "" }); ui.signupModal.classList.add('hidden'); showMessage('Account created!'); } catch (error) { showMessage(error.message, true); } });
        document.getElementById('login-form').addEventListener('submit', async e => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); ui.loginModal.classList.add('hidden'); showMessage('Logged in!'); navigateTo('home-section'); } catch (error) { showMessage(error.message, true); } });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- ARTICLES, LIKES, COMMENTS ---
        async function fetchAndDisplayArticles(articleQuery = query(collection(db, "articles"), where("status", "==", "published"), orderBy("submittedAt", "desc"), limit(9)), gridId = 'latest-articles-grid') {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '<p>Loading articles...</p>';
            try {
                const snapshot = await getDocs(articleQuery);
                grid.innerHTML = '';
                if (snapshot.empty) { grid.innerHTML = '<p>No articles found.</p>'; return; }
                snapshot.forEach(doc => {
                    const article = doc.data();
                    const card = document.createElement('div');
                    card.className = "bg-white rounded-xl shadow-lg flex flex-col cursor-pointer hover:shadow-2xl transition-shadow";
                    card.innerHTML = `<div class="p-6 flex-grow flex flex-col"><p class="text-sm font-semibold text-amber-600 uppercase">${article.category}</p><h3 class="text-xl font-bold mt-2 mb-3 flex-grow">${article.title}</h3><div class="flex items-center mt-4"><img src="${article.authorPic}" class="w-10 h-10 rounded-full mr-3 object-cover"><span class="text-slate-600 font-semibold">${article.authorName}</span></div></div>`;
                    card.addEventListener('click', () => navigateTo('article-view-section', doc.id));
                    grid.appendChild(card);
                });
            } catch (error) { grid.innerHTML = '<p>Could not load articles.</p>'; console.error(error); }
        }

        async function showArticle(articleId) {
            currentArticleId = articleId;
            try {
                const docRef = doc(db, "articles", articleId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const article = docSnap.data();
                    document.getElementById('article-view-category').textContent = article.category;
                    document.getElementById('article-view-title').textContent = article.title;
                    document.getElementById('article-view-author').innerHTML = `<img src="${article.authorPic}" class="w-12 h-12 rounded-full mr-4 object-cover"><div><p class="font-bold text-slate-800">${article.authorName}</p><p class="text-sm text-slate-500">${article.submittedAt.toDate().toLocaleDateString()}</p></div>`;
                    document.getElementById('article-view-content').innerHTML = markdownConverter.makeHtml(article.draft);
                    
                    const user = auth.currentUser;
                    const likeBtn = document.getElementById('like-article-btn');
                    likeBtn.disabled = !user || (article.likedBy && article.likedBy.includes(user.uid));
                    document.getElementById('like-count').textContent = `${article.likes || 0} likes`;

                    fetchAndDisplayComments(articleId);
                } else { showMessage('Article not found.', true); }
            } catch (error) { showMessage('Could not load article.', true); }
        }

        document.getElementById('like-article-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !currentArticleId) return;
            const articleRef = doc(db, "articles", currentArticleId);
            try {
                await runTransaction(db, async (transaction) => {
                    const articleDoc = await transaction.get(articleRef);
                    if (!articleDoc.exists()) throw "Article does not exist!";
                    
                    const articleData = articleDoc.data();
                    const currentLikes = articleData.likes || 0;
                    const likedBy = articleData.likedBy || [];

                    if (likedBy.includes(user.uid)) { 
                        // Intentionally do nothing for unlike for now
                    } else { // Like
                        transaction.update(articleRef, { likes: currentLikes + 1, likedBy: arrayUnion(user.uid) });
                    }
                });
                showArticle(currentArticleId); // Refresh view
            } catch (error) { showMessage("Error liking article.", true); console.error(error); }
        });

        async function fetchAndDisplayComments(articleId) {
            const commentsSection = document.getElementById('comments-section');
            commentsSection.innerHTML = `<h3 class="text-2xl font-bold mb-4">Comments</h3><div id="comments-list" class="space-y-4"></div>`;
            const user = auth.currentUser;
            if (user) {
                commentsSection.innerHTML += `<form id="comment-form" class="mt-6"><textarea id="comment-input" class="w-full p-2 border rounded-md" placeholder="Add a comment..." required></textarea><button type="submit" class="mt-2 bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg">Post Comment</button></form>`;
                document.getElementById('comment-form').addEventListener('submit', e => { e.preventDefault(); addComment(articleId); });
            } else {
                commentsSection.innerHTML += `<p class="mt-4 text-slate-600">Please log in to post a comment.</p>`;
            }

            const commentsQuery = query(collection(db, "articles", articleId, "comments"), orderBy("createdAt", "desc"));
            onSnapshot(commentsQuery, (snapshot) => {
                const list = document.getElementById('comments-list');
                list.innerHTML = '';
                if (snapshot.empty) { list.innerHTML = '<p>No comments yet.</p>'; }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    list.innerHTML += `<div class="bg-slate-50 p-4 rounded-lg"><div class="flex items-center mb-2"><img src="${comment.authorPic}" class="w-8 h-8 rounded-full mr-3"><span class="font-semibold">${comment.authorName}</span><span class="text-xs text-slate-500 ml-auto">${comment.createdAt.toDate().toLocaleString()}</span></div><p>${comment.text}</p></div>`;
                });
            });
        }

        async function addComment(articleId) {
            const user = auth.currentUser;
            const commentInput = document.getElementById('comment-input');
            if (!user || !commentInput.value.trim()) return;

            const userDoc = await getDoc(doc(db, "users", user.uid));
            const userData = userDoc.data();

            await addDoc(collection(db, "articles", articleId, "comments"), {
                text: commentInput.value,
                authorId: user.uid,
                authorName: userData.name || 'Anonymous',
                authorPic: userData.profilePicUrl || 'https://placehold.co/128x128/e2e8f0/334155?text=A',
                createdAt: serverTimestamp()
            });
            commentInput.value = '';
        }

        // --- TOPICS & CATEGORIES ---
        function displayTopics() {
            const grid = document.getElementById('topics-grid');
            grid.innerHTML = '';
            topics.forEach(topic => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-lg p-6 text-center cursor-pointer hover:bg-amber-500 hover:text-white transition-colors duration-300";
                card.innerHTML = `<h3 class="font-bold">${topic}</h3>`;
                card.addEventListener('click', () => navigateTo('category-view-section', topic));
                grid.appendChild(card);
            });
        }

        function showCategory(category) {
            document.getElementById('category-view-title').textContent = `Articles in: ${category}`;
            const q = query(collection(db, "articles"), where("category", "==", category), where("status", "==", "published"), orderBy("submittedAt", "desc"));
            fetchAndDisplayArticles(q, 'category-articles-grid');
        }

        // --- FORUM ---
        async function fetchForumPosts() { /* ... Forum logic ... */ }
        async function showForumPost(postId) { /* ... Forum logic ... */ }
        document.getElementById('create-post-btn').addEventListener('click', () => navigateTo('create-forum-post-section'));
        
        // --- CHAT ---
        function setupChat() {
            const user = auth.currentUser;
            const chatForm = document.getElementById('chat-form');
            if (!user) {
                document.getElementById('chat-messages').innerHTML = '<p class="text-center">Please log in to join the chat.</p>';
                chatForm.classList.add('hidden');
                return;
            }
            chatForm.classList.remove('hidden');

            const q = query(collection(db, "chatMessages"), orderBy("timestamp", "desc"), limit(50));
            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = '';
                const messages = snapshot.docs.reverse();
                messages.forEach(doc => {
                    const msg = doc.data();
                    messagesDiv.innerHTML += `<div class="mb-2"><div class="flex items-center"><img src="${msg.authorPic}" class="w-6 h-6 rounded-full mr-2"><span class="font-bold">${msg.authorName}</span></div><p class="ml-8">${msg.text}</p></div>`;
                });
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });

            chatForm.addEventListener('submit', async e => {
                e.preventDefault();
                const chatInput = document.getElementById('chat-input');
                if (!chatInput.value.trim()) return;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const userData = userDoc.data();
                await addDoc(collection(db, "chatMessages"), {
                    text: chatInput.value,
                    authorId: user.uid,
                    authorName: userData.name || 'Anonymous',
                    authorPic: userData.profilePicUrl || 'https://placehold.co/128x128/e2e8f0/334155?text=A',
                    timestamp: serverTimestamp()
                });
                chatInput.value = '';
            });
        }

        // --- MEMBERS & PROFILE ---
        async function fetchAndDisplayMembers() { /* ... Member logic ... */ }
        document.getElementById('profile-form').addEventListener('submit', async e => { /* ... Profile save logic ... */ });

        // --- INITIALIZATION ---
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', () => { ui.signupModal.classList.add('hidden'); ui.loginModal.classList.remove('hidden'); });
            document.getElementById('signup-btn').addEventListener('click', () => { ui.loginModal.classList.add('hidden'); ui.signupModal.classList.remove('hidden'); });
            document.getElementById('close-login-modal').addEventListener('click', () => ui.loginModal.classList.add('hidden'));
            document.getElementById('close-signup-modal').addEventListener('click', () => ui.signupModal.classList.add('hidden'));
            document.getElementById('mobile-menu-button').addEventListener('click', () => ui.mobileMenu.classList.toggle('hidden'));
            ui.backBtns.forEach(btn => btn.addEventListener('click', () => window.history.back())); // A simple back navigation
        }
        
        setupEventListeners();
        navigateTo('home-section');
    </script>
</body>
</html>
